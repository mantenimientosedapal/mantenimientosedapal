<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>SEDAPAL - Mantenimiento de Equipos TI</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
:root {
  --primary: #0057A8;
  --primary-dark: #003D75;
  --primary-light: #E8F1FA;
  --accent: #00B4D8;
  --accent-glow: rgba(0, 180, 216, 0.15);
  --success: #10B981;
  --success-bg: #ECFDF5;
  --warning: #F59E0B;
  --warning-bg: #FFFBEB;
  --danger: #EF4444;
  --danger-bg: #FEF2F2;
  --bg: #F0F4F8;
  --surface: #FFFFFF;
  --surface-hover: #F8FAFC;
  --text: #1E293B;
  --text-secondary: #64748B;
  --text-muted: #94A3B8;
  --border: #E2E8F0;
  --border-focus: #0057A8;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
  --shadow-lg: 0 8px 30px rgba(0,0,0,0.12);
  --radius: 12px;
  --radius-sm: 8px;
  --radius-lg: 16px;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
  -webkit-tap-highlight-color: transparent;
}

/* ===== HEADER ===== */
.header {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: white;
  padding: 16px 20px;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 20px rgba(0,87,168,0.3);
}

.header-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}

.header-logo {
  display: flex;
  align-items: center;
  gap: 10px;
}

.header-logo svg {
  width: 36px;
  height: 36px;
  flex-shrink: 0;
}

.header-title {
  font-size: 15px;
  font-weight: 700;
  letter-spacing: 0.3px;
  line-height: 1.2;
}

.header-subtitle {
  font-size: 11px;
  opacity: 0.8;
  font-weight: 400;
  margin-top: 2px;
}

.header-badge {
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(10px);
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  white-space: nowrap;
}

.header-info {
  display: flex;
  gap: 16px;
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid rgba(255,255,255,0.15);
  font-size: 11px;
  opacity: 0.85;
}

.header-info span {
  display: flex;
  align-items: center;
  gap: 4px;
}

/* ===== MAIN CONTENT ===== */
.main {
  padding: 16px;
  max-width: 600px;
  margin: 0 auto;
  padding-bottom: 100px;
}

/* ===== SECTIONS ===== */
.section {
  background: var(--surface);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 16px;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border);
  animation: slideUp 0.4s ease;
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(16px); }
  to { opacity: 1; transform: translateY(0); }
}

.section-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 16px;
}

.section-icon {
  width: 36px;
  height: 36px;
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.section-icon.blue { background: var(--primary-light); color: var(--primary); }
.section-icon.green { background: var(--success-bg); color: var(--success); }
.section-icon.orange { background: var(--warning-bg); color: var(--warning); }

.section-title {
  font-size: 15px;
  font-weight: 700;
  color: var(--text);
}

.section-desc {
  font-size: 12px;
  color: var(--text-secondary);
  margin-top: 1px;
}

/* ===== SEARCH BAR ===== */
.search-group {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
}

.search-input-wrap {
  flex: 1;
  position: relative;
}

.search-input {
  width: 100%;
  padding: 12px 14px 12px 42px;
  font-size: 15px;
  font-family: 'JetBrains Mono', monospace;
  font-weight: 500;
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--surface);
  color: var(--text);
  transition: all 0.2s;
  letter-spacing: 0.5px;
}

.search-input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(0,87,168,0.1);
}

.search-input::placeholder {
  font-family: 'DM Sans', sans-serif;
  font-weight: 400;
  color: var(--text-muted);
  letter-spacing: 0;
}

.search-icon {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
}

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 12px 16px;
  font-family: 'DM Sans', sans-serif;
  font-size: 14px;
  font-weight: 600;
  border: none;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
  -webkit-tap-highlight-color: transparent;
}

.btn:active { transform: scale(0.97); }

.btn-primary {
  background: var(--primary);
  color: white;
  box-shadow: 0 2px 8px rgba(0,87,168,0.3);
}
.btn-primary:hover { background: var(--primary-dark); }

.btn-scan {
  background: var(--accent);
  color: white;
  box-shadow: 0 2px 8px rgba(0,180,216,0.3);
  padding: 12px;
}

.btn-success {
  background: var(--success);
  color: white;
  box-shadow: 0 2px 8px rgba(16,185,129,0.3);
  width: 100%;
  padding: 14px;
  font-size: 15px;
}

.btn-outline {
  background: transparent;
  color: var(--primary);
  border: 2px solid var(--border);
}

.btn-danger-outline {
  background: transparent;
  color: var(--danger);
  border: 2px solid var(--danger);
}

.btn-danger-outline:hover {
  background: var(--danger-bg);
}

.btn-block { width: 100%; }

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

/* ===== SCAN SECTION ===== */
.scan-options {
  display: flex;
  gap: 8px;
}

.scan-options .btn {
  flex: 1;
  font-size: 13px;
  padding: 10px 12px;
}

#scannerContainer {
  display: none;
  margin-top: 12px;
  border-radius: var(--radius-sm);
  overflow: hidden;
  position: relative;
  background: #000;
}

#scannerContainer video {
  width: 100%;
  display: block;
  border-radius: var(--radius-sm);
}

.scanner-overlay {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: none;
}

.scanner-frame {
  width: 70%;
  height: 50px;
  border: 2px solid var(--accent);
  border-radius: 8px;
  box-shadow: 0 0 0 4000px rgba(0,0,0,0.4);
  position: relative;
}

.scanner-line {
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: var(--accent);
  animation: scanLine 2s infinite;
}

@keyframes scanLine {
  0%, 100% { top: 0; }
  50% { top: 100%; }
}

.scanner-close {
  position: absolute;
  top: 8px;
  right: 8px;
  background: rgba(0,0,0,0.6);
  color: white;
  border: none;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
  pointer-events: auto;
}

/* ===== DATA FIELDS ===== */
.data-grid {
  display: grid;
  gap: 12px;
}

.field-group {
  position: relative;
}

.field-label {
  font-size: 11px;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.8px;
  margin-bottom: 4px;
}

.field-value {
  padding: 10px 12px;
  background: var(--bg);
  border-radius: var(--radius-sm);
  font-size: 14px;
  font-weight: 500;
  color: var(--text);
  border: 1px solid var(--border);
  min-height: 40px;
  display: flex;
  align-items: center;
  word-break: break-word;
}

.field-value.editable {
  background: var(--surface);
  border: 2px solid var(--accent);
  cursor: text;
  position: relative;
}

.field-value.editable::after {
  content: '‚úèÔ∏è';
  position: absolute;
  right: 10px;
  font-size: 14px;
}

.field-input {
  width: 100%;
  padding: 10px 12px;
  font-size: 14px;
  font-family: 'DM Sans', sans-serif;
  font-weight: 500;
  border: 2px solid var(--accent);
  border-radius: var(--radius-sm);
  background: var(--surface);
  color: var(--text);
  transition: all 0.2s;
}

.field-input:focus {
  outline: none;
  box-shadow: 0 0 0 3px var(--accent-glow);
}

/* ===== VALIDATION STATUS ===== */
.validation-bar {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 14px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 12px;
}

.validation-bar.match {
  background: var(--success-bg);
  color: #065F46;
  border: 1px solid #A7F3D0;
}

.validation-bar.mismatch {
  background: var(--warning-bg);
  color: #92400E;
  border: 1px solid #FCD34D;
}

.validation-bar.error {
  background: var(--danger-bg);
  color: #991B1B;
  border: 1px solid #FCA5A5;
}

/* ===== SIGNATURE PAD ===== */
.signature-area {
  position: relative;
  margin-top: 8px;
}

.signature-canvas {
  width: 100%;
  height: 180px;
  border: 2px dashed var(--border);
  border-radius: var(--radius-sm);
  background: white;
  cursor: crosshair;
  touch-action: none;
}

.signature-canvas.signed {
  border-style: solid;
  border-color: var(--success);
}

.signature-placeholder {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: var(--text-muted);
  font-size: 13px;
  pointer-events: none;
  text-align: center;
}

.signature-actions {
  display: flex;
  gap: 8px;
  margin-top: 8px;
}

.signature-actions .btn { flex: 1; font-size: 13px; }

/* ===== CONFORMITY FIELDS ===== */
.conformity-fields {
  display: grid;
  gap: 12px;
  margin-bottom: 16px;
}

.conformity-input {
  width: 100%;
  padding: 10px 12px;
  font-size: 14px;
  font-family: 'DM Sans', sans-serif;
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--surface);
  color: var(--text);
  transition: all 0.2s;
}

.conformity-input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(0,87,168,0.1);
}

.conformity-select {
  width: 100%;
  padding: 10px 12px;
  font-size: 14px;
  font-family: 'DM Sans', sans-serif;
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--surface);
  color: var(--text);
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2364748B' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
}

/* ===== CHANGES LOG ===== */
.changes-log {
  background: var(--warning-bg);
  border: 1px solid #FCD34D;
  border-radius: var(--radius-sm);
  padding: 12px;
  margin-top: 12px;
}

.changes-log h4 {
  font-size: 12px;
  font-weight: 700;
  color: #92400E;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}

.change-item {
  font-size: 12px;
  color: #78350F;
  padding: 4px 0;
  border-bottom: 1px solid rgba(252,211,77,0.3);
  display: flex;
  gap: 6px;
}

.change-item:last-child { border-bottom: none; }

/* ===== MODAL ===== */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  backdrop-filter: blur(4px);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.modal-overlay.active { display: flex; }

.modal {
  background: var(--surface);
  border-radius: var(--radius-lg);
  padding: 24px;
  width: 100%;
  max-width: 400px;
  box-shadow: var(--shadow-lg);
  animation: modalIn 0.3s ease;
}

@keyframes modalIn {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}

.modal-icon {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 16px;
}

.modal-icon.success { background: var(--success-bg); color: var(--success); }
.modal-icon.error { background: var(--danger-bg); color: var(--danger); }

.modal h3 {
  text-align: center;
  font-size: 18px;
  margin-bottom: 8px;
}

.modal p {
  text-align: center;
  color: var(--text-secondary);
  font-size: 14px;
  margin-bottom: 20px;
  line-height: 1.5;
}

.modal .btn { margin-top: 8px; }

/* ===== TOAST ===== */
.toast {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: var(--text);
  color: white;
  padding: 12px 20px;
  border-radius: var(--radius);
  font-size: 13px;
  font-weight: 500;
  box-shadow: var(--shadow-lg);
  z-index: 2000;
  transition: transform 0.3s ease;
  white-space: nowrap;
}

.toast.show { transform: translateX(-50%) translateY(0); }

/* ===== CONFIG PANEL ===== */
.config-panel {
  display: none;
}

.config-panel.active { display: block; }

.config-input-group {
  margin-bottom: 16px;
}

.config-input-group label {
  display: block;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.config-input {
  width: 100%;
  padding: 10px 12px;
  font-size: 13px;
  font-family: 'JetBrains Mono', monospace;
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--surface);
  color: var(--text);
}

.config-input:focus {
  outline: none;
  border-color: var(--primary);
}

.config-help {
  font-size: 11px;
  color: var(--text-muted);
  margin-top: 4px;
  line-height: 1.5;
}

.config-status {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 500;
  margin-bottom: 16px;
}

.config-status.connected {
  background: var(--success-bg);
  color: #065F46;
}

.config-status.disconnected {
  background: var(--danger-bg);
  color: #991B1B;
}

/* ===== EMPTY STATE ===== */
.empty-state {
  text-align: center;
  padding: 40px 20px;
}

.empty-state svg {
  color: var(--text-muted);
  margin-bottom: 16px;
}

.empty-state h3 {
  font-size: 16px;
  color: var(--text);
  margin-bottom: 6px;
}

.empty-state p {
  font-size: 13px;
  color: var(--text-secondary);
  line-height: 1.5;
}

/* ===== LOADER ===== */
.loader {
  display: none;
  text-align: center;
  padding: 30px;
}

.loader.active { display: block; }

.spinner {
  width: 36px;
  height: 36px;
  border: 3px solid var(--border);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin: 0 auto 12px;
}

@keyframes spin { to { transform: rotate(360deg); } }

.loader-text {
  font-size: 13px;
  color: var(--text-secondary);
}

/* ===== TECH NAME FIELD ===== */
.tech-name-bar {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 14px;
  background: var(--primary-light);
  border-radius: var(--radius-sm);
  margin-bottom: 12px;
  font-size: 13px;
}

.tech-name-bar input {
  flex: 1;
  border: none;
  background: transparent;
  font-family: 'DM Sans', sans-serif;
  font-size: 13px;
  font-weight: 600;
  color: var(--primary-dark);
  outline: none;
}

.tech-name-bar input::placeholder {
  color: var(--primary);
  opacity: 0.6;
  font-weight: 400;
}

/* ===== COUNTER ===== */
.counter-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: var(--primary-light);
  color: var(--primary);
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  margin-left: auto;
}

/* ===== HISTORY ===== */
.history-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px;
  border-bottom: 1px solid var(--border);
  font-size: 13px;
}

.history-item:last-child { border-bottom: none; }

.history-item .code {
  font-family: 'JetBrains Mono', monospace;
  font-weight: 600;
  color: var(--primary);
  font-size: 13px;
}

.history-item .time {
  color: var(--text-muted);
  font-size: 11px;
  margin-left: auto;
  white-space: nowrap;
}

.history-item .status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

.status-dot.ok { background: var(--success); }
.status-dot.mod { background: var(--warning); }

/* ===== TABS ===== */
.tabs {
  display: flex;
  gap: 4px;
  background: var(--bg);
  padding: 4px;
  border-radius: var(--radius-sm);
  margin-bottom: 16px;
}

.tab {
  flex: 1;
  padding: 8px;
  font-size: 12px;
  font-weight: 600;
  text-align: center;
  border: none;
  background: transparent;
  border-radius: 6px;
  cursor: pointer;
  color: var(--text-secondary);
  font-family: 'DM Sans', sans-serif;
  transition: all 0.2s;
}

.tab.active {
  background: var(--surface);
  color: var(--primary);
  box-shadow: var(--shadow-sm);
}

/* ===== RESPONSIVE ===== */
@media (max-width: 360px) {
  .header-title { font-size: 13px; }
  .main { padding: 12px; }
  .section { padding: 16px; }
}
</style>
</head>
<body>

<!-- HEADER -->
<header class="header">
  <div class="header-top">
    <div class="header-logo">
      <svg viewBox="0 0 40 40" fill="none">
        <rect width="40" height="40" rx="10" fill="rgba(255,255,255,0.15)"/>
        <path d="M12 14h16v2H12zm0 5h16v2H12zm0 5h10v2H12z" fill="white" opacity="0.9"/>
        <circle cx="30" cy="28" r="5" fill="#00B4D8"/>
        <path d="M28.5 28l1 1 2-2" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <div>
        <div class="header-title">Mantenimiento de Equipos TI</div>
        <div class="header-subtitle">GGSE - ETIC ¬∑ SEDAPAL</div>
      </div>
    </div>
    <div class="header-badge" id="connectionBadge">‚öôÔ∏è Config</div>
  </div>
  <div class="header-info">
    <span>üìç SEDE: COP La Atarjea</span>
    <span>üìÖ <span id="currentDate"></span></span>
  </div>
</header>

<!-- MAIN CONTENT -->
<div class="main">

  <!-- CONFIG PANEL -->
  <div class="section config-panel" id="configPanel">
    <div class="section-header">
      <div class="section-icon blue">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
      </div>
      <div>
        <div class="section-title">Configuraci√≥n</div>
        <div class="section-desc">Conectar con Google Sheets</div>
      </div>
    </div>

    <div id="configStatus" class="config-status disconnected">
      üî¥ No conectado a Google Sheets
    </div>

    <div class="config-input-group">
      <label>ID de Google Sheet</label>
      <input type="text" class="config-input" id="sheetId" placeholder="Ej: 1BxiM...kGh8">
      <div class="config-help">Encu√©ntralo en la URL de tu Google Sheet:<br>docs.google.com/spreadsheets/d/<strong>[ID_AQU√ç]</strong>/edit</div>
    </div>

    <div class="config-input-group">
      <label>Nombre de la hoja</label>
      <input type="text" class="config-input" id="sheetName" placeholder="Ej: Inventario_Mantenimiento" value="Inventario_Mantenimiento">
      <div class="config-help">Nombre exacto de la pesta√±a en tu spreadsheet</div>
    </div>

    <div class="config-input-group">
      <label>API Key de Google</label>
      <input type="text" class="config-input" id="apiKey" placeholder="AIza...">
      <div class="config-help">
        Necesitas una API Key de Google Cloud con acceso a Sheets API.<br>
        <strong>Alternativa sin API Key:</strong> Publica tu Sheet como web (Archivo ‚Üí Compartir ‚Üí Publicar en la web ‚Üí CSV) y usa el modo p√∫blico.
      </div>
    </div>

    <div style="display: flex; gap: 8px; margin-bottom: 12px;">
      <label style="display:flex; align-items:center; gap:6px; font-size:13px; cursor:pointer;">
        <input type="checkbox" id="publicMode"> Usar modo p√∫blico (Sheet publicado como CSV)
      </label>
    </div>

    <div style="display: flex; gap: 8px;">
      <button class="btn btn-primary btn-block" onclick="saveConfig()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17,21 17,13 7,13 7,21"/><polyline points="7,3 7,8 15,8"/></svg>
        Guardar y Conectar
      </button>
      <button class="btn btn-outline" onclick="loadDemoData()" style="white-space:nowrap;">
        Demo
      </button>
    </div>

    <div class="config-help" style="margin-top: 12px; padding: 10px; background: var(--primary-light); border-radius: 8px;">
      <strong>üí° Modo Demo:</strong> Presiona "Demo" para probar la app con datos de ejemplo sin necesidad de Google Sheets.
    </div>

    <div style="margin-top:16px;padding-top:16px;border-top:2px dashed var(--border);">
      <div style="font-size:13px;font-weight:700;color:#10B981;margin-bottom:8px;">‚òÅÔ∏è GUARDAR CAMBIOS EN GOOGLE SHEETS</div>
      <div class="config-help" style="margin-bottom:10px;">
        Al registrar un mantenimiento, se env√≠a el registro completo a una hoja de Google Sheets. Necesitas la <strong>URL del Web App</strong> (ver gu√≠a de Apps Script).
      </div>
      <div class="config-input-group">
        <label>URL del Web App (Google Apps Script)</label>
        <input type="text" class="config-input" id="webhookUrl" placeholder="https://script.google.com/macros/s/AKfy.../exec">
      </div>
      <div id="webhookStatus" style="display:none;" class="validation-bar match"></div>
    </div>

    <div style="margin-top:16px;padding-top:16px;border-top:2px dashed var(--border);">
      <div style="font-size:13px;font-weight:700;color:var(--primary);margin-bottom:8px;">üìÇ CARGAR ARCHIVO CSV (RECOMENDADO)</div>
      <div class="config-help" style="margin-bottom:10px;">
        Carga el archivo <strong>inventario_mantenimiento.csv</strong> directamente desde tu celular. Funciona sin internet despu√©s de cargarlo.
      </div>
      <label class="btn btn-success btn-block" style="cursor:pointer;position:relative;margin-bottom:8px;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17,8 12,3 7,8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        Seleccionar archivo CSV
        <input type="file" accept=".csv" id="csvFileInput" onchange="loadCSVFile(this)" style="position:absolute;opacity:0;width:100%;height:100%;top:0;left:0;cursor:pointer;">
      </label>
      <div id="csvStatus" style="display:none;" class="validation-bar match"></div>
      <div class="config-help">
        <strong>¬øDe d√≥nde obtengo el CSV?</strong><br>
        1. Abre el Excel <em>SEDAPAL_Inventario_Mantenimiento_TI.xlsx</em> en tu PC<br>
        2. Haz clic en <strong>Archivo ‚Üí Guardar como ‚Üí CSV UTF-8 (.csv)</strong><br>
        3. Env√≠a el CSV a tu celular por WhatsApp, correo o Drive<br>
        4. C√°rgalo aqu√≠. ¬°Los datos quedan guardados en el navegador!
      </div>
    </div>
  </div>

  <!-- SEARCH SECTION -->
  <div class="section" id="searchSection">
    <div class="section-header">
      <div class="section-icon blue">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      </div>
      <div>
        <div class="section-title">Buscar Equipo</div>
        <div class="section-desc">Ingrese c√≥digo de inventario o escanee</div>
      </div>
    </div>

    <div class="tech-name-bar">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      <input type="text" id="techName" placeholder="Nombre del t√©cnico de mantenimiento">
    </div>

    <div class="search-group">
      <div class="search-input-wrap">
        <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input type="text" class="search-input" id="equipCode" placeholder="C√≥digo de inventario..." autocomplete="off">
      </div>
      <button class="btn btn-primary" onclick="searchEquipment()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      </button>
    </div>

    <div class="scan-options">
      <button class="btn btn-scan" onclick="startBarcodeScanner()" style="flex:1;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><line x1="6" y1="8" x2="6" y2="16"/><line x1="9" y1="8" x2="9" y2="16"/><line x1="12" y1="8" x2="14" y2="16"/><line x1="17" y1="8" x2="17" y2="16"/></svg>
        Escanear C√≥digo
      </button>
      <button class="btn btn-scan" onclick="startSerialScanner()" style="flex:1;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2"/><path d="M7 7h.01M7 12h.01M7 17h.01M12 7h.01M12 12h.01M12 17h.01M17 7h.01M17 12h.01"/></svg>
        Escanear Serie
      </button>
    </div>

    <div id="scannerContainer">
      <video id="scannerVideo" autoplay playsinline></video>
      <div class="scanner-overlay">
        <div class="scanner-frame">
          <div class="scanner-line"></div>
        </div>
      </div>
      <button class="scanner-close" onclick="stopScanner()">‚úï</button>
    </div>
  </div>

  <!-- LOADER -->
  <div class="loader" id="loader">
    <div class="spinner"></div>
    <div class="loader-text">Buscando equipo en la base de datos...</div>
  </div>

  <!-- EQUIPMENT DATA (hidden initially) -->
  <div id="equipmentSection" style="display:none;">

    <!-- EQUIPMENT INFO -->
    <div class="section" style="animation-delay: 0.1s;">
      <div class="section-header">
        <div class="section-icon blue">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
        </div>
        <div>
          <div class="section-title">Datos del Equipo</div>
          <div class="section-desc">Verificar informaci√≥n del equipo</div>
        </div>
        <span class="counter-badge" id="matchBadge">‚Äî</span>
      </div>

      <div id="validationBar" class="validation-bar match" style="display:none;"></div>

      <div class="data-grid" id="dataGrid">
        <!-- Populated dynamically -->
      </div>

      <div id="changesLog" class="changes-log" style="display:none;">
        <h4>üìù Cambios Realizados</h4>
        <div id="changesList"></div>
      </div>
    </div>

    <!-- SERIAL SCAN & VERIFICATION -->
    <div class="section" style="animation-delay: 0.2s;">
      <div class="section-header">
        <div class="section-icon orange">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><line x1="6" y1="8" x2="6" y2="16"/><line x1="9" y1="8" x2="9" y2="16"/><line x1="12" y1="8" x2="14" y2="16"/><line x1="17" y1="8" x2="17" y2="16"/></svg>
        </div>
        <div>
          <div class="section-title">Verificaci√≥n de Series</div>
          <div class="section-desc">Validar series de todos los perif√©ricos</div>
        </div>
      </div>

      <div id="serialChecklist" style="display:flex;flex-direction:column;gap:8px;">
        <!-- Populated dynamically -->
      </div>

      <div style="margin-top:12px;">
        <div class="search-group">
          <div class="search-input-wrap">
            <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><line x1="6" y1="8" x2="6" y2="16"/></svg>
            <input type="text" class="search-input" id="serialInput" placeholder="Escanear o ingresar serie para verificar...">
          </div>
          <button class="btn btn-scan" onclick="startSerialScanVerify()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>
          </button>
        </div>
        <button class="btn btn-outline btn-block" onclick="verifySerialAuto()" style="font-size:13px;">
          üîç Buscar serie en perif√©ricos del equipo
        </button>
      </div>

      <div id="serialResult" style="margin-top: 10px;"></div>
    </div>

    <!-- SIGNATURE & CONFORMITY -->
    <div class="section" style="animation-delay: 0.3s;">
      <div class="section-header">
        <div class="section-icon green">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M9 12l2 2 4-4"/></svg>
        </div>
        <div>
          <div class="section-title">Conformidad del Usuario</div>
          <div class="section-desc">Firma del usuario que recibe el equipo</div>
        </div>
      </div>

      <div class="conformity-fields">
        <div class="field-group">
          <div class="field-label">Nombre completo del usuario</div>
          <input type="text" class="conformity-input" id="userName" placeholder="Nombre del usuario que firma">
        </div>
        <div class="field-group">
          <div class="field-label">DNI del usuario</div>
          <input type="text" class="conformity-input" id="userDni" placeholder="DNI" maxlength="8" inputmode="numeric">
        </div>
        <div class="field-group">
          <div class="field-label">Estado del mantenimiento</div>
          <select class="conformity-select" id="maintStatus">
            <option value="">Seleccionar...</option>
            <option value="Conforme">‚úÖ Conforme - Equipo operativo</option>
            <option value="Conforme con observaciones">‚ö†Ô∏è Conforme con observaciones</option>
            <option value="No conforme">‚ùå No conforme</option>
          </select>
        </div>
        <div class="field-group" id="obsGroup" style="display:none;">
          <div class="field-label">Observaciones</div>
          <textarea class="conformity-input" id="observations" placeholder="Detalle las observaciones..." rows="3" style="resize:vertical;"></textarea>
        </div>
      </div>

      <div class="field-label">FIRMA DEL USUARIO</div>
      <div class="signature-area">
        <canvas class="signature-canvas" id="signatureCanvas"></canvas>
        <div class="signature-placeholder" id="sigPlaceholder">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17 3a2.828 2.828 0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
          <br>Firmar aqu√≠
        </div>
      </div>
      <div class="signature-actions">
        <button class="btn btn-outline" onclick="clearSignature()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1,4 1,10 7,10"/><path d="M3.51 15a9 9 0 102.13-9.36L1 10"/></svg>
          Limpiar
        </button>
        <button class="btn btn-outline" onclick="undoSignature()">
          ‚Ü© Deshacer
        </button>
      </div>
    </div>

    <!-- SUBMIT -->
    <button class="btn btn-success" onclick="submitMaintenance()" id="submitBtn">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22,4 12,14.01 9,11.01"/></svg>
      Registrar Mantenimiento
    </button>

  </div>

  <!-- HISTORY -->
  <div class="section" id="historySection">
    <div class="section-header">
      <div class="section-icon green">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg>
      </div>
      <div>
        <div class="section-title">Historial de Sesi√≥n</div>
        <div class="section-desc">Equipos procesados hoy</div>
      </div>
      <span class="counter-badge" id="historyCount">0</span>
    </div>
    <div id="historyList">
      <div class="empty-state">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
        <h3>Sin registros a√∫n</h3>
        <p>Los equipos procesados aparecer√°n aqu√≠</p>
      </div>
    </div>
  </div>

</div>

<!-- SUCCESS MODAL -->
<div class="modal-overlay" id="successModal">
  <div class="modal">
    <div class="modal-icon success">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20,6 9,17 4,12"/></svg>
    </div>
    <h3>¬°Mantenimiento Registrado!</h3>
    <p id="successMessage">El equipo ha sido registrado correctamente.</p>
    <button class="btn btn-primary btn-block" onclick="closeModal(); resetForm();">Registrar Otro Equipo</button>
    <button class="btn btn-outline btn-block" onclick="exportRecord()" style="margin-top:6px;">
      üìÑ Descargar Comprobante
    </button>
  </div>
</div>

<!-- ERROR MODAL -->
<div class="modal-overlay" id="errorModal">
  <div class="modal">
    <div class="modal-icon error">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
    </div>
    <h3 id="errorTitle">Error</h3>
    <p id="errorMessage">Ha ocurrido un error.</p>
    <button class="btn btn-primary btn-block" onclick="closeModal()">Entendido</button>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ===== APP STATE =====
const APP = {
  config: {
    sheetId: '',
    sheetName: 'Hoja1',
    apiKey: '',
    publicMode: false,
    connected: false
  },
  currentEquipment: null,
  originalData: null,
  changes: [],
  history: [],
  isDemo: false,
  csvData: null,
  scanMode: null, // 'code' or 'serial'
  scanStream: null,
  signatureStrokes: [],
  currentStroke: [],
  hasSigned: false
};

// ===== DEMO DATA =====
const DEMO_DATA = [
  { 'C√ìDIGO INVENTARIO': 'COL2264', 'CATEGOR√çA': 'LAPTOP', 'TIPO DE EQUIPO': 'LAPTOP TIPO 3', 'MARCA': 'LENOVO', 'MODELO': 'THINKPAD P1 GEN 5', 'SERIE EQUIPO': 'PW05T1GT', 'PROPIETARIO': 'Fonafe-Colsof', 'NOMBRE HOST': 'COL2264', 'DIRECCI√ìN IP': '172.16.41.53', 'PROCESADOR': 'INTEL CORE i7', 'MEMORIA RAM': '64 GB', 'ALMACENAMIENTO': '1 TB', 'MARCA MONITOR 1': 'LENOVO', 'MODELO MONITOR 1': 'E24-29', 'SERIE MONITOR 1': 'VVM59830', 'PULGADAS MONITOR 1': 'LED-24', 'MARCA MONITOR 2': '', 'MODELO MONITOR 2': '', 'SERIE MONITOR 2': '', 'PULGADAS MONITOR 2': '', 'MARCA TECLADO': '', 'TIPO TECLADO': '', 'SERIE TECLADO': '', 'MARCA MOUSE': '', 'TIPO MOUSE': '', 'SERIE MOUSE': '', 'CONDICI√ìN': 'EN PRODUCCION', 'ESTADO': 'OPERATIVO', 'SEDE': 'COP Atarjea Nueva Sede', 'ZONA DE INVENTARIO': 'COP Atarjea.Edificio CDTA.2do Piso', 'PISO': '2DO PISO', 'REFERENCIA UBICACI√ìN': 'SOPORTE Y AUTOMATIZACION', 'GERENCIA': 'GERENCIA DE DESARROLLO E INVESTIGACION', 'EQUIPO FUNCIONAL': 'EQUIPO TECNOLOGIAS DE LA INFORMACION Y COMUNICACIONES', 'GRUPO FUNCIONAL': 'ETIC.GESTION DE SERVICIOS', 'FICHA USUARIO': '16132', 'USUARIO ASIGNADO': 'Silupu Sandoval, Keytin Briggit', 'CARGO': 'T√©cnico en Scada', 'TIPO ASIGNACI√ìN': 'ESTABLE', 'T√âCNICO RESPONSABLE': 'Fernando Mes√≠as Medina' },
  { 'C√ìDIGO INVENTARIO': 'COL1998', 'CATEGOR√çA': 'PC', 'TIPO DE EQUIPO': 'PC', 'MARCA': 'LENOVO', 'MODELO': 'THINKCENTRE M70Q', 'SERIE EQUIPO': 'MJ0KJBH0', 'PROPIETARIO': 'Fonafe-Colsof', 'NOMBRE HOST': 'COL1998', 'DIRECCI√ìN IP': '1.1.222.134', 'PROCESADOR': 'INTEL CORE i5', 'MEMORIA RAM': '8 GB', 'ALMACENAMIENTO': '512 GB', 'MARCA MONITOR 1': 'LENOVO', 'MODELO MONITOR 1': 'E24-29', 'SERIE MONITOR 1': 'VVM54821', 'PULGADAS MONITOR 1': 'LED-24', 'MARCA MONITOR 2': 'LENOVO', 'MODELO MONITOR 2': 'E24-29', 'SERIE MONITOR 2': 'VVM59455', 'PULGADAS MONITOR 2': 'LED-24', 'MARCA TECLADO': 'LENOVO', 'TIPO TECLADO': 'USB', 'SERIE TECLADO': '4107822', 'MARCA MOUSE': 'LENOVO', 'TIPO MOUSE': 'USB', 'SERIE MOUSE': '5519744', 'CONDICI√ìN': 'EN PRODUCCION', 'ESTADO': 'OPERATIVO', 'SEDE': 'Centro de Servicio Ate', 'ZONA DE INVENTARIO': 'Centro de Servicio Ate', 'PISO': '1ER PISO', 'REFERENCIA UBICACI√ìN': 'ATENCION AL CLIENTE', 'GERENCIA': 'GERENCIA DE SERVICIOS CENTRO', 'EQUIPO FUNCIONAL': 'EQUIPO COMERCIAL ATE VITARTE', 'GRUPO FUNCIONAL': 'ECAV.COMERCIAL', 'FICHA USUARIO': '15320', 'USUARIO ASIGNADO': 'Condori Uria, Ricardo Moises', 'CARGO': 'T√©cnico Comercial', 'TIPO ASIGNACI√ìN': 'ESTABLE', 'T√âCNICO RESPONSABLE': 'Daniel Jes√∫s Zapana Goyas' },
  { 'C√ìDIGO INVENTARIO': '1810103', 'CATEGOR√çA': 'PC', 'TIPO DE EQUIPO': 'PC', 'MARCA': 'LENOVO', 'MODELO': '3209-1T2', 'SERIE EQUIPO': 'MJ8691C', 'PROPIETARIO': 'Sedapal', 'NOMBRE HOST': '1810103-S', 'DIRECCI√ìN IP': '172.16.12.45', 'PROCESADOR': 'INTEL CORE i5', 'MEMORIA RAM': '8 GB', 'ALMACENAMIENTO': '500 GB', 'MARCA MONITOR 1': 'LENOVO', 'MODELO MONITOR 1': '5047-HB2', 'SERIE MONITOR 1': 'VNA3RTK', 'PULGADAS MONITOR 1': 'LCD-17', 'MARCA MONITOR 2': '', 'MODELO MONITOR 2': '', 'SERIE MONITOR 2': '', 'PULGADAS MONITOR 2': '', 'MARCA TECLADO': 'LENOVO', 'TIPO TECLADO': 'USB', 'SERIE TECLADO': '3955891', 'MARCA MOUSE': 'LENOVO', 'TIPO MOUSE': 'USB', 'SERIE MOUSE': '44V5123', 'CONDICI√ìN': 'EN PRODUCCION', 'ESTADO': 'PRESTAMO', 'SEDE': 'COP Atarjea Nueva Sede', 'ZONA DE INVENTARIO': 'COP Atarjea.Edificio CDTA.3er Piso', 'PISO': '3ER PISO', 'REFERENCIA UBICACI√ìN': 'OPERACIONES FINANCIERAS', 'GERENCIA': 'GERENCIA DE FINANZAS', 'EQUIPO FUNCIONAL': 'EQUIPO OPERACIONES FINANCIERAS', 'GRUPO FUNCIONAL': 'EOF.OPERACIONES', 'FICHA USUARIO': '13948', 'USUARIO ASIGNADO': 'Torres Felix, Carlos Felipe', 'CARGO': 'Jefe del Equipo Operaciones Financieras', 'TIPO ASIGNACI√ìN': 'JEFE DE EQUIPO', 'T√âCNICO RESPONSABLE': 'Joel Jean Rojas Medina' },
  { 'C√ìDIGO INVENTARIO': 'COL0815', 'CATEGOR√çA': 'PC', 'TIPO DE EQUIPO': 'PC', 'MARCA': 'LENOVO', 'MODELO': 'THINKCENTRE M70Q GEN 3', 'SERIE EQUIPO': 'MJ0KQ419', 'PROPIETARIO': 'Fonafe-Colsof', 'NOMBRE HOST': 'COL0815', 'DIRECCI√ìN IP': '11.1.7.17', 'PROCESADOR': 'INTEL CORE i5', 'MEMORIA RAM': '8 GB', 'ALMACENAMIENTO': '512 GB', 'MARCA MONITOR 1': 'LENOVO', 'MODELO MONITOR 1': 'T24i-30', 'SERIE MONITOR 1': 'VNA8XK2', 'PULGADAS MONITOR 1': 'LED-24', 'MARCA MONITOR 2': '', 'MODELO MONITOR 2': '', 'SERIE MONITOR 2': '', 'PULGADAS MONITOR 2': '', 'MARCA TECLADO': 'LENOVO', 'TIPO TECLADO': 'USB', 'SERIE TECLADO': '4190312', 'MARCA MOUSE': 'LENOVO', 'TIPO MOUSE': 'USB', 'SERIE MOUSE': '5634102', 'CONDICI√ìN': 'EN PRODUCCION', 'ESTADO': 'OPERATIVO', 'SEDE': 'COP Atarjea Nueva Sede', 'ZONA DE INVENTARIO': 'COP Atarjea.Edificio CDTA.4to Piso', 'PISO': '4TO PISO', 'REFERENCIA UBICACI√ìN': 'RECURSOS HUMANOS', 'GERENCIA': 'GERENCIA DE RECURSOS HUMANOS', 'EQUIPO FUNCIONAL': 'EQUIPO GESTION DEL TALENTO', 'GRUPO FUNCIONAL': 'EGT.TALENTO', 'FICHA USUARIO': '14850', 'USUARIO ASIGNADO': 'Leon Velasquez, Jorge Luis', 'CARGO': 'Analista de Recursos Humanos', 'TIPO ASIGNACI√ìN': 'ESTABLE', 'T√âCNICO RESPONSABLE': 'Gerardo Flavio Mendoza Pacheco' },
];

// ===== FIELD CONFIG (organized by groups) =====
const FIELD_GROUPS = [
  {
    name: 'üì¶ DATOS DEL EQUIPO',
    color: '#0057A8',
    fields: [
      { key: 'C√ìDIGO INVENTARIO', label: 'C√≥digo de Inventario', editable: false, isCode: true },
      { key: 'CATEGOR√çA', label: 'Categor√≠a', editable: false },
      { key: 'TIPO DE EQUIPO', label: 'Tipo de Equipo', editable: false },
      { key: 'MARCA', label: 'Marca', editable: true },
      { key: 'MODELO', label: 'Modelo', editable: true },
      { key: 'SERIE EQUIPO', label: 'Serie del Equipo (CPU/Laptop)', editable: true, isSerie: true },
      { key: 'PROPIETARIO', label: 'Propietario', editable: false },
      { key: 'NOMBRE HOST', label: 'Nombre de Host', editable: true },
      { key: 'DIRECCI√ìN IP', label: 'Direcci√≥n IP', editable: true },
      { key: 'PROCESADOR', label: 'Procesador', editable: false },
      { key: 'MEMORIA RAM', label: 'Memoria RAM', editable: false },
      { key: 'ALMACENAMIENTO', label: 'Almacenamiento', editable: false },
    ]
  },
  {
    name: 'üñ•Ô∏è MONITOR PRINCIPAL',
    color: '#0891B2',
    fields: [
      { key: 'MARCA MONITOR 1', label: 'Marca Monitor 1', editable: true },
      { key: 'MODELO MONITOR 1', label: 'Modelo Monitor 1', editable: true },
      { key: 'SERIE MONITOR 1', label: 'Serie Monitor 1', editable: true, isSerie: true },
      { key: 'PULGADAS MONITOR 1', label: 'Pulgadas', editable: false },
    ]
  },
  {
    name: 'üñ•Ô∏è SEGUNDO MONITOR',
    color: '#7C3AED',
    fields: [
      { key: 'MARCA MONITOR 2', label: 'Marca Monitor 2', editable: true },
      { key: 'MODELO MONITOR 2', label: 'Modelo Monitor 2', editable: true },
      { key: 'SERIE MONITOR 2', label: 'Serie Monitor 2', editable: true, isSerie: true },
      { key: 'PULGADAS MONITOR 2', label: 'Pulgadas', editable: false },
    ]
  },
  {
    name: '‚å®Ô∏è TECLADO',
    color: '#D97706',
    fields: [
      { key: 'MARCA TECLADO', label: 'Marca Teclado', editable: true },
      { key: 'TIPO TECLADO', label: 'Tipo Teclado', editable: false },
      { key: 'SERIE TECLADO', label: 'Serie Teclado', editable: true, isSerie: true },
    ]
  },
  {
    name: 'üñ±Ô∏è MOUSE',
    color: '#059669',
    fields: [
      { key: 'MARCA MOUSE', label: 'Marca Mouse', editable: true },
      { key: 'TIPO MOUSE', label: 'Tipo Mouse', editable: false },
      { key: 'SERIE MOUSE', label: 'Serie Mouse', editable: true, isSerie: true },
    ]
  },
  {
    name: 'üìç UBICACI√ìN',
    color: '#2563EB',
    fields: [
      { key: 'SEDE', label: 'Sede', editable: false },
      { key: 'ZONA DE INVENTARIO', label: 'Zona de Inventario', editable: true },
      { key: 'PISO', label: 'Piso', editable: true },
      { key: 'REFERENCIA UBICACI√ìN', label: 'Referencia de Ubicaci√≥n', editable: true },
    ]
  },
  {
    name: 'üè¢ ORGANIZACI√ìN',
    color: '#7C2D12',
    fields: [
      { key: 'GERENCIA', label: 'Gerencia', editable: false },
      { key: 'EQUIPO FUNCIONAL', label: 'Equipo Funcional', editable: false },
      { key: 'GRUPO FUNCIONAL', label: 'Grupo Funcional', editable: false },
    ]
  },
  {
    name: 'üë§ USUARIO ASIGNADO',
    color: '#4338CA',
    fields: [
      { key: 'FICHA USUARIO', label: 'Ficha', editable: false },
      { key: 'USUARIO ASIGNADO', label: 'Nombre del Usuario', editable: true },
      { key: 'CARGO', label: 'Cargo', editable: false },
      { key: 'TIPO ASIGNACI√ìN', label: 'Tipo de Asignaci√≥n', editable: false },
      { key: 'T√âCNICO RESPONSABLE', label: 'T√©cnico Responsable', editable: false },
    ]
  },
];

// Flat version for compatibility
const FIELD_CONFIG = FIELD_GROUPS.flatMap(g => g.fields);

// ===== INIT =====
document.addEventListener('DOMContentLoaded', () => {
  initDate();
  loadConfig();
  initSignature();
  initEventListeners();
});

function initDate() {
  const now = new Date();
  document.getElementById('currentDate').textContent = now.toLocaleDateString('es-PE', { day: '2-digit', month: 'short', year: 'numeric' });
}

function initEventListeners() {
  document.getElementById('equipCode').addEventListener('keypress', e => {
    if (e.key === 'Enter') searchEquipment();
  });

  document.getElementById('connectionBadge').addEventListener('click', toggleConfig);

  document.getElementById('maintStatus').addEventListener('change', function() {
    document.getElementById('obsGroup').style.display = this.value.includes('observaciones') || this.value === 'No conforme' ? 'block' : 'none';
  });

  document.getElementById('serialInput').addEventListener('keypress', e => {
    if (e.key === 'Enter') verifySerial();
  });
}

// ===== CONFIG =====
function toggleConfig() {
  const panel = document.getElementById('configPanel');
  panel.classList.toggle('active');
}

function loadConfig() {
  try {
    const saved = localStorage.getItem('sedapal_maint_config');
    if (saved) {
      Object.assign(APP.config, JSON.parse(saved));
      document.getElementById('sheetId').value = APP.config.sheetId;
      document.getElementById('sheetName').value = APP.config.sheetName;
      document.getElementById('apiKey').value = APP.config.apiKey;
      document.getElementById('publicMode').checked = APP.config.publicMode;
      if (APP.config.webhookUrl) document.getElementById('webhookUrl').value = APP.config.webhookUrl;
      updateConnectionStatus();
    }

    // Try loading cached CSV data first
    if (!loadCachedCSV()) {
      // Try auto-loading CSV from same directory (GitHub Pages)
      autoLoadCSV();
    }

    const savedHistory = localStorage.getItem('sedapal_maint_history_' + new Date().toISOString().slice(0, 10));
    if (savedHistory) {
      APP.history = JSON.parse(savedHistory);
      renderHistory();
    }
  } catch(e) { console.log('Config load error:', e); }
}

function saveConfig() {
  APP.config.sheetId = document.getElementById('sheetId').value.trim();
  APP.config.sheetName = document.getElementById('sheetName').value.trim() || 'Inventario_Mantenimiento';
  APP.config.apiKey = document.getElementById('apiKey').value.trim();
  APP.config.publicMode = document.getElementById('publicMode').checked;
  APP.config.webhookUrl = document.getElementById('webhookUrl').value.trim();
  APP.config.connected = !!(APP.config.sheetId && (APP.config.apiKey || APP.config.publicMode));
  APP.isDemo = false;

  localStorage.setItem('sedapal_maint_config', JSON.stringify(APP.config));
  updateConnectionStatus();

  if (APP.config.connected) {
    document.getElementById('configPanel').classList.remove('active');
    showToast('‚úÖ Configuraci√≥n guardada');
  } else {
    showError('Configuraci√≥n incompleta', 'Ingrese el ID del Sheet y una API Key, o active el modo p√∫blico.');
  }
}

function loadDemoData() {
  APP.isDemo = true;
  APP.config.connected = true;
  APP.csvData = null;
  updateConnectionStatus();
  document.getElementById('configPanel').classList.remove('active');
  showToast('üéÆ Modo Demo ‚Äî Prueba con: COL2264, COL1998, 1810103, COL0815');
}

// ===== CSV FILE LOADING =====
function loadCSVFile(input) {
  const file = input.files[0];
  if (!file) return;

  showToast('üìÇ Cargando archivo...');
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const text = e.target.result;
      const data = parseCSV(text);
      if (data.length === 0) {
        showError('Archivo vac√≠o', 'El archivo CSV no contiene datos v√°lidos.');
        return;
      }
      APP.csvData = data;
      APP.isDemo = false;
      APP.config.connected = true;

      // Save to localStorage for persistence
      try { localStorage.setItem('sedapal_csv_data', text); } catch(e) { /* too large */ }
      try { localStorage.setItem('sedapal_csv_date', new Date().toISOString()); } catch(e) {}

      updateConnectionStatus();
      document.getElementById('csvStatus').style.display = 'flex';
      document.getElementById('csvStatus').innerHTML = `‚úÖ ${data.length} equipos cargados desde CSV ‚Äî ${file.name}`;
      document.getElementById('configPanel').classList.remove('active');
      showToast(`‚úÖ ${data.length} equipos cargados correctamente`);
    } catch(err) {
      showError('Error al leer CSV', 'No se pudo procesar el archivo: ' + err.message);
    }
  };
  reader.readAsText(file, 'UTF-8');
}

function parseCSV(text) {
  const lines = text.split('\n').filter(l => l.trim());
  if (lines.length < 2) return [];

  // Parse header
  const headers = parseCSVLine(lines[0]);
  const data = [];

  for (let i = 1; i < lines.length; i++) {
    const values = parseCSVLine(lines[i]);
    if (values.length < 3) continue; // skip empty rows
    const obj = {};
    headers.forEach((h, idx) => {
      const val = (values[idx] || '').trim();
      if (val && val !== 'nan' && val !== 'None' && val !== 'NaT') {
        obj[h.trim()] = val;
      }
    });
    if (obj['C√ìDIGO INVENTARIO'] || obj[headers[0]]) {
      data.push(obj);
    }
  }
  return data;
}

function parseCSVLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (ch === '"') {
      if (inQuotes && line[i+1] === '"') { current += '"'; i++; }
      else { inQuotes = !inQuotes; }
    } else if (ch === ',' && !inQuotes) {
      result.push(current);
      current = '';
    } else {
      current += ch;
    }
  }
  result.push(current);
  return result;
}

function loadCachedCSV() {
  try {
    const cached = localStorage.getItem('sedapal_csv_data');
    const cachedDate = localStorage.getItem('sedapal_csv_date');
    if (cached) {
      const data = parseCSV(cached);
      if (data.length > 0) {
        APP.csvData = data;
        APP.config.connected = true;
        updateConnectionStatus();
        const dateStr = cachedDate ? new Date(cachedDate).toLocaleDateString('es-PE') : 'fecha desconocida';
        document.getElementById('csvStatus').style.display = 'flex';
        document.getElementById('csvStatus').innerHTML = `‚úÖ ${data.length} equipos en memoria (cargado: ${dateStr})`;
        return true;
      }
    }
  } catch(e) {}
  return false;
}

async function autoLoadCSV() {
  try {
    const resp = await fetch('inventario_mantenimiento.csv');
    if (!resp.ok) throw new Error('No CSV file');
    const text = await resp.text();
    const data = parseCSV(text);
    if (data.length > 0) {
      APP.csvData = data;
      APP.config.connected = true;
      try { localStorage.setItem('sedapal_csv_data', text); } catch(e) {}
      try { localStorage.setItem('sedapal_csv_date', new Date().toISOString()); } catch(e) {}
      updateConnectionStatus();
      document.getElementById('csvStatus').style.display = 'flex';
      document.getElementById('csvStatus').innerHTML = `‚úÖ ${data.length} equipos cargados autom√°ticamente`;
      showToast(`‚úÖ ${data.length} equipos cargados`);
      return;
    }
  } catch(e) {
    console.log('Auto-load CSV not available:', e.message);
  }
  // If auto-load failed, show config
  if (!APP.config.connected) {
    document.getElementById('configPanel').classList.add('active');
  }
}

function updateConnectionStatus() {
  const badge = document.getElementById('connectionBadge');
  const status = document.getElementById('configStatus');

  if (APP.isDemo) {
    badge.textContent = 'üéÆ Demo';
    badge.style.background = 'rgba(245,158,11,0.2)';
    status.className = 'config-status connected';
    status.textContent = 'üü° Modo Demo activo';
  } else if (APP.csvData) {
    badge.textContent = `üìÇ ${APP.csvData.length}`;
    badge.style.background = 'rgba(16,185,129,0.2)';
    status.className = 'config-status connected';
    status.textContent = `üü¢ CSV cargado ‚Äî ${APP.csvData.length} equipos`;
  } else if (APP.config.connected) {
    badge.textContent = 'üü¢ Online';
    badge.style.background = 'rgba(16,185,129,0.2)';
    status.className = 'config-status connected';
    status.textContent = 'üü¢ Conectado a Google Sheets';
  } else {
    badge.textContent = '‚öôÔ∏è Config';
    badge.style.background = 'rgba(255,255,255,0.15)';
    status.className = 'config-status disconnected';
    status.textContent = 'üî¥ No conectado a Google Sheets';
  }
}

// ===== SEARCH =====
async function searchEquipment() {
  const code = document.getElementById('equipCode').value.trim();
  if (!code) { showToast('‚ö†Ô∏è Ingrese un c√≥digo de inventario'); return; }
  if (!APP.config.connected && !APP.isDemo && !APP.csvData) { showError('Sin datos', 'Cargue un archivo CSV o configure Google Sheets primero. Toque ‚öôÔ∏è arriba.'); return; }

  showLoader(true);
  document.getElementById('equipmentSection').style.display = 'none';

  try {
    let data;
    if (APP.isDemo) {
      await delay(800);
      data = DEMO_DATA.find(r => r['C√ìDIGO INVENTARIO'].toLowerCase().includes(code.toLowerCase()));
    } else if (APP.csvData) {
      await delay(300);
      // Search in loaded CSV data
      data = APP.csvData.find(r => {
        const ci = (r['C√ìDIGO INVENTARIO'] || r[Object.keys(r)[0]] || '').toString().toLowerCase();
        return ci === code.toLowerCase() || ci.includes(code.toLowerCase());
      });
    } else {
      data = await fetchFromSheets(code);
    }

    showLoader(false);

    if (data) {
      APP.currentEquipment = { ...data };
      APP.originalData = { ...data };
      APP.changes = [];
      // Reset serial validation
      Object.keys(serialValidation).forEach(k => delete serialValidation[k]);
      SERIAL_FIELDS.forEach(sf => {
        if (findFieldValue(data, sf.key)) serialValidation[sf.key] = 'pending';
      });
      renderEquipment(data);
      renderSerialChecklist();
      document.getElementById('equipmentSection').style.display = 'block';
      document.getElementById('equipmentSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
      showToast('‚úÖ Equipo encontrado');
    } else {
      showError('Equipo no encontrado', `No se encontr√≥ ning√∫n equipo con el c√≥digo "${code}". Verifique el c√≥digo e intente nuevamente.`);
    }
  } catch (err) {
    showLoader(false);
    showError('Error de conexi√≥n', 'No se pudo conectar con Google Sheets. Verifique su configuraci√≥n e internet. ' + err.message);
  }
}

async function fetchFromSheets(code) {
  let url;
  if (APP.config.publicMode) {
    url = `https://docs.google.com/spreadsheets/d/${APP.config.sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(APP.config.sheetName)}&tq=${encodeURIComponent("SELECT * WHERE A CONTAINS '" + code.replace(/'/g, "''") + "'")}`;
  } else {
    const range = `${APP.config.sheetName}!A:J`;
    url = `https://sheets.googleapis.com/v4/spreadsheets/${APP.config.sheetId}/values/${encodeURIComponent(range)}?key=${APP.config.apiKey}`;
  }

  const resp = await fetch(url);

  if (APP.config.publicMode) {
    const text = await resp.text();
    const json = JSON.parse(text.substring(47).slice(0, -2));
    const cols = json.table.cols.map(c => c.label);
    const rows = json.table.rows;

    if (rows.length === 0) return null;

    const row = rows[0];
    const obj = {};
    cols.forEach((col, i) => {
      if (col) obj[col] = row.c[i] ? row.c[i].v : '';
    });
    return obj;
  } else {
    const json = await resp.json();
    if (!json.values || json.values.length < 2) return null;

    const headers = json.values[0];
    const found = json.values.slice(1).find(row => {
      const codeIdx = headers.findIndex(h => h.toUpperCase().includes('C√ìDIGO') || h.toUpperCase().includes('CODIGO') || h.toUpperCase().includes('INVENTARIO'));
      return codeIdx >= 0 && row[codeIdx] && row[codeIdx].toLowerCase().includes(code.toLowerCase());
    });

    if (!found) return null;

    const obj = {};
    headers.forEach((h, i) => { obj[h] = found[i] || ''; });
    return obj;
  }
}

// ===== RENDER EQUIPMENT =====
function renderEquipment(data) {
  const grid = document.getElementById('dataGrid');
  grid.innerHTML = '';

  FIELD_GROUPS.forEach(group => {
    // Check if group has any data
    const hasData = group.fields.some(f => {
      const val = findFieldValue(data, f.key);
      return val && val.trim() !== '';
    });
    if (!hasData && group.name.includes('SEGUNDO MONITOR')) return; // skip empty 2nd monitor

    // Group header
    const groupDiv = document.createElement('div');
    groupDiv.style.cssText = `margin-top:12px;margin-bottom:8px;padding:6px 10px;background:${group.color}15;border-left:3px solid ${group.color};border-radius:0 6px 6px 0;font-size:12px;font-weight:700;color:${group.color};letter-spacing:0.5px;`;
    groupDiv.textContent = group.name;
    grid.appendChild(groupDiv);

    group.fields.forEach(field => {
      const value = findFieldValue(data, field.key);
      if (!value && !field.editable) return; // skip empty non-editable

      const div = document.createElement('div');
      div.className = 'field-group';

      const serieTag = field.isSerie ? `<span style="display:inline-block;background:#FEF2F2;color:#DC2626;font-size:9px;font-weight:700;padding:1px 5px;border-radius:4px;margin-left:4px;">VALIDAR</span>` : '';
      const codeStyle = field.isCode ? `font-family:'JetBrains Mono',monospace;font-weight:700;color:var(--primary);font-size:15px;` : '';

      if (field.editable) {
        div.innerHTML = `
          <div class="field-label">${field.label}${serieTag}</div>
          <input type="text" class="field-input" 
            data-key="${field.key}" 
            data-original="${value}" 
            value="${value}" 
            style="${field.isSerie ? 'font-family:JetBrains Mono,monospace;color:#DC2626;font-weight:600;' : ''}"
            onchange="trackChange(this)">
        `;
      } else {
        div.innerHTML = `
          <div class="field-label">${field.label}</div>
          <div class="field-value" style="${codeStyle}">${value || '‚Äî'}</div>
        `;
      }
      grid.appendChild(div);
    });
  });

  updateValidationStatus();
}

function findFieldValue(data, key) {
  if (data[key] !== undefined) return data[key];
  const upperKey = key.toUpperCase();
  for (let k of Object.keys(data)) {
    if (k.toUpperCase() === upperKey || k.toUpperCase().includes(upperKey.split('/')[0])) return data[k];
  }
  return '';
}

function trackChange(input) {
  const key = input.dataset.key;
  const original = input.dataset.original;
  const current = input.value;

  APP.changes = APP.changes.filter(c => c.field !== key);
  if (current !== original) {
    APP.changes.push({ field: key, original, updated: current });
  }

  if (APP.currentEquipment) {
    APP.currentEquipment[key] = current;
  }

  updateValidationStatus();
  renderChanges();
}

function updateValidationStatus() {
  const bar = document.getElementById('validationBar');
  const badge = document.getElementById('matchBadge');

  if (APP.changes.length === 0) {
    bar.style.display = 'flex';
    bar.className = 'validation-bar match';
    bar.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20,6 9,17 4,12"/></svg> Todos los datos coinciden con la base de datos';
    badge.textContent = '‚úÖ OK';
    badge.style.background = 'var(--success-bg)';
    badge.style.color = 'var(--success)';
  } else {
    bar.style.display = 'flex';
    bar.className = 'validation-bar mismatch';
    bar.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg> ${APP.changes.length} campo(s) modificado(s)`;
    badge.textContent = `‚ö†Ô∏è ${APP.changes.length}`;
    badge.style.background = 'var(--warning-bg)';
    badge.style.color = 'var(--warning)';
  }
}

function renderChanges() {
  const log = document.getElementById('changesLog');
  const list = document.getElementById('changesList');

  if (APP.changes.length === 0) {
    log.style.display = 'none';
    return;
  }

  log.style.display = 'block';
  list.innerHTML = APP.changes.map(c => `
    <div class="change-item">
      <span>üîÑ</span>
      <span><strong>${c.field}:</strong> "${c.original}" ‚Üí "${c.updated}"</span>
    </div>
  `).join('');
}

// ===== SERIAL VERIFICATION =====
const SERIAL_FIELDS = [
  { key: 'SERIE EQUIPO', label: 'Serie Equipo (CPU/Laptop)', icon: 'üíª' },
  { key: 'SERIE MONITOR 1', label: 'Serie Monitor Principal', icon: 'üñ•Ô∏è' },
  { key: 'SERIE MONITOR 2', label: 'Serie Segundo Monitor', icon: 'üñ•Ô∏è' },
  { key: 'SERIE TECLADO', label: 'Serie Teclado', icon: '‚å®Ô∏è' },
  { key: 'SERIE MOUSE', label: 'Serie Mouse', icon: 'üñ±Ô∏è' },
];

const serialValidation = {};

function renderSerialChecklist() {
  const container = document.getElementById('serialChecklist');
  if (!APP.currentEquipment) return;

  container.innerHTML = SERIAL_FIELDS.map(sf => {
    const dbVal = findFieldValue(APP.currentEquipment, sf.key);
    if (!dbVal) return '';
    const status = serialValidation[sf.key];
    const statusIcon = status === 'ok' ? '‚úÖ' : status === 'fail' ? '‚ùå' : '‚è≥';
    const statusColor = status === 'ok' ? '#10B981' : status === 'fail' ? '#EF4444' : '#94A3B8';
    const statusBg = status === 'ok' ? '#ECFDF5' : status === 'fail' ? '#FEF2F2' : '#F8FAFC';

    return `<div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:${statusBg};border-radius:8px;border:1px solid ${statusColor}20;">
      <span style="font-size:16px;">${statusIcon}</span>
      <div style="flex:1;min-width:0;">
        <div style="font-size:11px;font-weight:600;color:var(--text-secondary);">${sf.icon} ${sf.label}</div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:600;color:${statusColor};overflow:hidden;text-overflow:ellipsis;">${dbVal}</div>
      </div>
      <span style="font-size:10px;font-weight:700;color:${statusColor};text-transform:uppercase;">${status === 'ok' ? 'Validado' : status === 'fail' ? 'No coincide' : 'Pendiente'}</span>
    </div>`;
  }).filter(Boolean).join('');
}

function verifySerialAuto() {
  const input = document.getElementById('serialInput').value.trim();
  const result = document.getElementById('serialResult');

  if (!input) { showToast('‚ö†Ô∏è Ingrese un n√∫mero de serie'); return; }
  if (!APP.currentEquipment) { showToast('‚ö†Ô∏è Primero busque un equipo'); return; }

  let found = false;
  SERIAL_FIELDS.forEach(sf => {
    const dbVal = findFieldValue(APP.currentEquipment, sf.key);
    if (dbVal && input.toLowerCase() === dbVal.toLowerCase()) {
      serialValidation[sf.key] = 'ok';
      found = true;
      result.innerHTML = `<div class="validation-bar match">‚úÖ ¬°Coincide! Serie "${input}" corresponde a: <strong>${sf.label}</strong></div>`;
    }
  });

  if (!found) {
    // Check which serials exist for a helpful message
    const existing = SERIAL_FIELDS.filter(sf => findFieldValue(APP.currentEquipment, sf.key)).map(sf => `${sf.icon} ${sf.label}: <strong>${findFieldValue(APP.currentEquipment, sf.key)}</strong>`);
    result.innerHTML = `<div class="validation-bar mismatch">‚ö†Ô∏è Serie "${input}" no coincide con ning√∫n perif√©rico registrado.</div>
    <div style="margin-top:8px;padding:10px;background:#F8FAFC;border-radius:8px;font-size:12px;line-height:1.8;">
      <strong>Series registradas:</strong><br>${existing.join('<br>')}
    </div>`;
  }

  document.getElementById('serialInput').value = '';
  renderSerialChecklist();
}

function verifySerial() { verifySerialAuto(); }

// ===== SCANNER =====
async function startBarcodeScanner() {
  APP.scanMode = 'code';
  await startCamera();
}

async function startSerialScanner() {
  APP.scanMode = 'serial_search';
  await startCamera();
}

async function startSerialScanVerify() {
  APP.scanMode = 'serial_verify';
  await startCamera();
}

async function startCamera() {
  const container = document.getElementById('scannerContainer');
  const video = document.getElementById('scannerVideo');

  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
    });
    APP.scanStream = stream;
    video.srcObject = stream;
    container.style.display = 'block';
    showToast('üì∏ C√°mara activa ‚Äî Apunte al c√≥digo');

    // Simple barcode detection using BarcodeDetector API if available
    if ('BarcodeDetector' in window) {
      const detector = new BarcodeDetector({ formats: ['code_128', 'code_39', 'ean_13', 'qr_code', 'data_matrix'] });
      const scanInterval = setInterval(async () => {
        if (!APP.scanStream) { clearInterval(scanInterval); return; }
        try {
          const barcodes = await detector.detect(video);
          if (barcodes.length > 0) {
            const value = barcodes[0].rawValue;
            clearInterval(scanInterval);
            handleScannedValue(value);
            stopScanner();
          }
        } catch(e) { /* continue scanning */ }
      }, 500);
    } else {
      showToast('‚ÑπÔ∏è Detecci√≥n autom√°tica no disponible. Ingrese el valor manualmente.');
    }
  } catch(err) {
    showError('Error de c√°mara', 'No se pudo acceder a la c√°mara. Verifique los permisos del navegador.');
  }
}

function handleScannedValue(value) {
  if (APP.scanMode === 'code') {
    document.getElementById('equipCode').value = value;
    searchEquipment();
  } else if (APP.scanMode === 'serial_search') {
    document.getElementById('equipCode').value = value;
    searchEquipment();
  } else if (APP.scanMode === 'serial_verify') {
    document.getElementById('serialInput').value = value;
    verifySerial();
  }
  showToast('‚úÖ C√≥digo escaneado: ' + value);
}

function stopScanner() {
  const container = document.getElementById('scannerContainer');
  if (APP.scanStream) {
    APP.scanStream.getTracks().forEach(t => t.stop());
    APP.scanStream = null;
  }
  container.style.display = 'none';
}

// ===== SIGNATURE =====
function initSignature() {
  const canvas = document.getElementById('signatureCanvas');
  const ctx = canvas.getContext('2d');

  function resize() {
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width * 2;
    canvas.height = rect.height * 2;
    ctx.scale(2, 2);
    ctx.strokeStyle = '#1E293B';
    ctx.lineWidth = 2.5;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    redrawSignature();
  }

  resize();
  window.addEventListener('resize', resize);

  let drawing = false;

  function getPos(e) {
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches ? e.touches[0] : e;
    return { x: touch.clientX - rect.left, y: touch.clientY - rect.top };
  }

  function startDraw(e) {
    e.preventDefault();
    drawing = true;
    APP.currentStroke = [getPos(e)];
    document.getElementById('sigPlaceholder').style.display = 'none';
  }

  function draw(e) {
    if (!drawing) return;
    e.preventDefault();
    const pos = getPos(e);
    APP.currentStroke.push(pos);

    ctx.beginPath();
    const pts = APP.currentStroke;
    if (pts.length >= 2) {
      ctx.moveTo(pts[pts.length-2].x, pts[pts.length-2].y);
      ctx.lineTo(pos.x, pos.y);
      ctx.stroke();
    }
  }

  function endDraw(e) {
    if (!drawing) return;
    e.preventDefault();
    drawing = false;
    if (APP.currentStroke.length > 1) {
      APP.signatureStrokes.push([...APP.currentStroke]);
      APP.hasSigned = true;
      canvas.classList.add('signed');
    }
    APP.currentStroke = [];
  }

  canvas.addEventListener('mousedown', startDraw);
  canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('mouseup', endDraw);
  canvas.addEventListener('mouseleave', endDraw);
  canvas.addEventListener('touchstart', startDraw, { passive: false });
  canvas.addEventListener('touchmove', draw, { passive: false });
  canvas.addEventListener('touchend', endDraw, { passive: false });
}

function redrawSignature() {
  const canvas = document.getElementById('signatureCanvas');
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.strokeStyle = '#1E293B';
  ctx.lineWidth = 2.5;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';

  APP.signatureStrokes.forEach(stroke => {
    if (stroke.length < 2) return;
    ctx.beginPath();
    ctx.moveTo(stroke[0].x, stroke[0].y);
    for (let i = 1; i < stroke.length; i++) {
      ctx.lineTo(stroke[i].x, stroke[i].y);
    }
    ctx.stroke();
  });
}

function clearSignature() {
  APP.signatureStrokes = [];
  APP.hasSigned = false;
  const canvas = document.getElementById('signatureCanvas');
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  canvas.classList.remove('signed');
  document.getElementById('sigPlaceholder').style.display = 'block';
}

function undoSignature() {
  if (APP.signatureStrokes.length === 0) return;
  APP.signatureStrokes.pop();
  if (APP.signatureStrokes.length === 0) {
    APP.hasSigned = false;
    document.getElementById('signatureCanvas').classList.remove('signed');
    document.getElementById('sigPlaceholder').style.display = 'block';
  }
  redrawSignature();
}

// ===== SUBMIT =====
function submitMaintenance() {
  const techName = document.getElementById('techName').value.trim();
  const userName = document.getElementById('userName').value.trim();
  const userDni = document.getElementById('userDni').value.trim();
  const status = document.getElementById('maintStatus').value;
  const obs = document.getElementById('observations')?.value?.trim() || '';

  // Validations
  if (!techName) { showToast('‚ö†Ô∏è Ingrese el nombre del t√©cnico'); document.getElementById('techName').focus(); return; }
  if (!APP.currentEquipment) { showToast('‚ö†Ô∏è Primero busque un equipo'); return; }
  if (!userName) { showToast('‚ö†Ô∏è Ingrese el nombre del usuario'); document.getElementById('userName').focus(); return; }
  if (!userDni || userDni.length < 8) { showToast('‚ö†Ô∏è Ingrese un DNI v√°lido (8 d√≠gitos)'); document.getElementById('userDni').focus(); return; }
  if (!status) { showToast('‚ö†Ô∏è Seleccione el estado del mantenimiento'); return; }
  if (!APP.hasSigned) { showToast('‚ö†Ô∏è Se requiere la firma del usuario'); return; }

  // Build the updated equipment with current field values
  const updatedEquipment = { ...APP.currentEquipment };
  document.querySelectorAll('.field-input[data-key]').forEach(input => {
    updatedEquipment[input.dataset.key] = input.value;
  });

  const record = {
    timestamp: new Date().toISOString(),
    technician: techName,
    code: findFieldValue(APP.currentEquipment, 'C√ìDIGO INVENTARIO'),
    equipment: updatedEquipment,
    changes: [...APP.changes],
    userName,
    userDni,
    status,
    observations: obs,
    signature: document.getElementById('signatureCanvas').toDataURL('image/png')
  };

  APP.history.unshift(record);
  localStorage.setItem('sedapal_maint_history_' + new Date().toISOString().slice(0, 10), JSON.stringify(APP.history));

  // Send to Google Sheets if webhook configured
  sendToGoogleSheets(record);

  renderHistory();

  const code = record.code;
  document.getElementById('successMessage').textContent = `Equipo ${code} registrado como "${status}" por ${userName}.`;
  document.getElementById('successModal').classList.add('active');
}

// ===== SEND TO GOOGLE SHEETS =====
async function sendToGoogleSheets(record) {
  const url = APP.config.webhookUrl;
  if (!url) return; // No webhook configured

  // Build flat row with all fields
  const eq = record.equipment;
  const COLS = FIELD_GROUPS.flatMap(g => g.fields.map(f => f.key));

  const payload = {
    FECHA: new Date(record.timestamp).toLocaleString('es-PE'),
    T√âCNICO: record.technician,
    C√ìDIGO_INVENTARIO: record.code,
  };

  // Add all equipment fields
  COLS.forEach(key => {
    const clean = key.replace(/ /g, '_');
    payload[clean] = findFieldValue(eq, key) || '';
  });

  // Add maintenance info
  payload.CAMBIOS_REALIZADOS = record.changes.map(c => `${c.field}: ${c.original} ‚Üí ${c.updated}`).join(' | ') || 'Sin cambios';
  payload.USUARIO_CONFORMIDAD = record.userName;
  payload.DNI_USUARIO = record.userDni;
  payload.ESTADO_CONFORMIDAD = record.status;
  payload.OBSERVACIONES = record.observations || '';
  payload.TIENE_FIRMA = 'S√ç';

  // Serial validation status
  payload.VALIDACION_SERIES = SERIAL_FIELDS.map(sf => {
    const st = serialValidation[sf.key];
    return st ? `${sf.label}: ${st === 'ok' ? '‚úÖ' : st === 'fail' ? '‚ùå' : '‚è≥'}` : '';
  }).filter(Boolean).join(' | ');

  try {
    await fetch(url, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify(payload)
    });
    showToast('‚òÅÔ∏è Registro enviado a Google Sheets');
  } catch(err) {
    console.error('Error sending to Sheets:', err);
    showToast('‚ö†Ô∏è No se pudo enviar a Google Sheets (se guard√≥ localmente)');
    // Queue for later retry
    try {
      const queue = JSON.parse(localStorage.getItem('sedapal_pending_sync') || '[]');
      queue.push(payload);
      localStorage.setItem('sedapal_pending_sync', JSON.stringify(queue));
    } catch(e) {}
  }
}

function resetForm() {
  APP.currentEquipment = null;
  APP.originalData = null;
  APP.changes = [];
  document.getElementById('equipCode').value = '';
  document.getElementById('serialInput').value = '';
  document.getElementById('serialResult').innerHTML = '';
  document.getElementById('userName').value = '';
  document.getElementById('userDni').value = '';
  document.getElementById('maintStatus').value = '';
  document.getElementById('observations').value = '';
  document.getElementById('obsGroup').style.display = 'none';
  document.getElementById('equipmentSection').style.display = 'none';
  clearSignature();
  document.getElementById('equipCode').focus();
}

// ===== HISTORY =====
function renderHistory() {
  const list = document.getElementById('historyList');
  const count = document.getElementById('historyCount');
  count.textContent = APP.history.length;

  if (APP.history.length === 0) {
    list.innerHTML = `<div class="empty-state"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg><h3>Sin registros a√∫n</h3><p>Los equipos procesados aparecer√°n aqu√≠</p></div>`;
    return;
  }

  list.innerHTML = APP.history.map(h => {
    const time = new Date(h.timestamp).toLocaleTimeString('es-PE', { hour: '2-digit', minute: '2-digit' });
    const hasMods = h.changes && h.changes.length > 0;
    return `
      <div class="history-item">
        <div class="status-dot ${hasMods ? 'mod' : 'ok'}"></div>
        <div>
          <div class="code">${h.code}</div>
          <div style="font-size:11px;color:var(--text-muted);">${h.status} ‚Äî ${h.userName}</div>
        </div>
        <div class="time">${time}</div>
      </div>
    `;
  }).join('');
}

// ===== EXPORT =====
function exportRecord() {
  if (APP.history.length === 0) return;
  const last = APP.history[0];

  const content = `
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë     SEDAPAL - COMPROBANTE DE MANTENIMIENTO PREVENTIVO       ‚ïë
‚ïë                   GGSE - ETIC                               ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

FECHA: ${new Date(last.timestamp).toLocaleString('es-PE')}
T√âCNICO: ${last.technician}

${FIELD_GROUPS.map(g => `‚îÄ‚îÄ ${g.name} ${'‚îÄ'.repeat(Math.max(0, 50 - g.name.length))}
${g.fields.map(f => `${f.label}: ${findFieldValue(last.equipment, f.key) || '‚Äî'}`).join('\n')}`).join('\n\n')}

‚îÄ‚îÄ CAMBIOS REALIZADOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${last.changes.length > 0 ? last.changes.map(c => `‚Ä¢ ${c.field}: "${c.original}" ‚Üí "${c.updated}"`).join('\n') : 'Ninguno ‚Äî Datos coinciden con la base de datos'}

‚îÄ‚îÄ CONFORMIDAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
USUARIO: ${last.userName}
DNI: ${last.userDni}
ESTADO: ${last.status}
${last.observations ? 'OBSERVACIONES: ' + last.observations : ''}

FIRMA: [Registrada digitalmente]
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  `.trim();

  const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `Mantenimiento_${last.code}_${new Date().toISOString().slice(0,10)}.txt`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('üìÑ Comprobante descargado');
}

// ===== UTILITIES =====
function showLoader(show) {
  document.getElementById('loader').classList.toggle('active', show);
}

function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2500);
}

function showError(title, message) {
  document.getElementById('errorTitle').textContent = title;
  document.getElementById('errorMessage').textContent = message;
  document.getElementById('errorModal').classList.add('active');
}

function closeModal() {
  document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
}

function delay(ms) { return new Promise(r => setTimeout(r, ms)); }
</script>
</body>
</html>
