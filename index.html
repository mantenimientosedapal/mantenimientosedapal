// ============================================================
// GOOGLE APPS SCRIPT — RECEPTOR DE MANTENIMIENTO SEDAPAL v7
// ============================================================
// NUEVO v7: Genera PDF (RMP) automáticamente y lo guarda en Drive
// + Firmas del técnico y usuario guardadas en Drive
// + PDF organizado por carpetas mensuales
// + Link del PDF en la hoja de Sheets
//
// INSTRUCCIONES:
// 1. Apps Script → Borra todo → Pega este código → Guarda
// 2. Implementar → Gestionar implementaciones → ✏️ → Nueva versión → Implementar
// 3. Se crearán carpetas automáticas en Drive
// ============================================================

var SHEET_NAME = "REGISTROS_MANTENIMIENTO";
var DRIVE_FOLDER_NAME = "SEDAPAL_Fotos_Mantenimiento";
var PDF_FOLDER_NAME = "SEDAPAL_RMP_PDF";

var COLUMNS = [
  "FECHA", "TÉCNICO", "CÓDIGO_INVENTARIO", "CATEGORÍA", "TIPO_DE_EQUIPO",
  "MARCA", "MODELO", "SERIE_EQUIPO", "PROPIETARIO", "NOMBRE_HOST",
  "DIRECCIÓN_IP", "PROCESADOR", "MEMORIA_RAM", "ALMACENAMIENTO",
  "MARCA_MONITOR_1", "MODELO_MONITOR_1", "SERIE_MONITOR_1", "PULGADAS_MONITOR_1",
  "MARCA_MONITOR_2", "MODELO_MONITOR_2", "SERIE_MONITOR_2", "PULGADAS_MONITOR_2",
  "MARCA_TECLADO", "TIPO_TECLADO", "SERIE_TECLADO",
  "MARCA_MOUSE", "TIPO_MOUSE", "SERIE_MOUSE",
  "SEDE", "ZONA_DE_INVENTARIO", "PISO", "REFERENCIA_UBICACIÓN",
  "GERENCIA", "EQUIPO_FUNCIONAL", "GRUPO_FUNCIONAL",
  "FICHA_USUARIO", "USUARIO_ASIGNADO", "CARGO", "TIPO_ASIGNACIÓN", "TÉCNICO_RESPONSABLE",
  "CAMBIOS_REALIZADOS", "USUARIO_CONFORMIDAD", "DNI_USUARIO",
  "ESTADO_CONFORMIDAD", "OBSERVACIONES", "TIENE_FIRMA", "VALIDACION_SERIES",
  "FOTO_EQUIPO", "FOTO_CODIGO", "FOTO_CAMBIO",
  "ENCUESTA_TRATO", "ENCUESTA_CONFORMIDAD",
  "FIRMA_TECNICO_LINK", "FIRMA_USUARIO_LINK",
  "PDF_RMP_LINK", "HORA_INICIO", "HORA_FIN", "DURACION"
];

function doPost(e) {
  try {
    var data;
    if (e.parameter && e.parameter.data) {
      data = JSON.parse(e.parameter.data);
    } else if (e.postData && e.postData.contents) {
      data = JSON.parse(e.postData.contents);
    } else {
      throw new Error("No data received");
    }
    
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName(SHEET_NAME);
    if (!sheet) sheet = createSheet(ss);
    
    var code = data["CÓDIGO_INVENTARIO"] || "SIN_CODIGO";
    var fecha = (data["FECHA"] || "").replace(/[\/: ]/g, "_").substring(0, 15);
    
    // ===== SAVE PHOTOS TO DRIVE =====
    var photoFields = ["FOTO_EQUIPO", "FOTO_CODIGO", "FOTO_CAMBIO"];
    var photoNames = ["equipo", "codigo_inv", "cambio_periferico"];
    for (var i = 0; i < photoFields.length; i++) {
      var base64 = data[photoFields[i]];
      if (base64 && base64.length > 100) {
        data[photoFields[i]] = savePhotoToDrive(base64, code + "_" + photoNames[i] + "_" + fecha + ".jpg");
      } else {
        data[photoFields[i]] = "";
      }
    }
    
    // ===== SAVE SIGNATURES TO DRIVE =====
    var firmaTecLink = "";
    var firmaUsrLink = "";
    if (data["FIRMA_TECNICO"] && data["FIRMA_TECNICO"].length > 100) {
      firmaTecLink = savePhotoToDrive(data["FIRMA_TECNICO"], "firma_tec_" + code + "_" + fecha + ".png");
    }
    if (data["FIRMA_USUARIO"] && data["FIRMA_USUARIO"].length > 100) {
      firmaUsrLink = savePhotoToDrive(data["FIRMA_USUARIO"], "firma_usr_" + code + "_" + fecha + ".png");
    }
    data["FIRMA_TECNICO_LINK"] = firmaTecLink;
    data["FIRMA_USUARIO_LINK"] = firmaUsrLink;
    
    // ===== GENERATE PDF AND SAVE TO DRIVE =====
    var pdfLink = "";
    try {
      pdfLink = generateAndSavePDF(data, code, fecha);
    } catch(pdfErr) {
      pdfLink = "Error PDF: " + pdfErr.toString();
    }
    data["PDF_RMP_LINK"] = pdfLink;
    
    // ===== BUILD ROW =====
    var row = COLUMNS.map(function(col) {
      return data[col] || "";
    });
    
    sheet.appendRow(row);
    var lastRow = sheet.getLastRow();
    var newRange = sheet.getRange(lastRow, 1, 1, COLUMNS.length);
    
    // Format
    newRange.setFontColor("#1E293B");
    newRange.setFontWeight("normal");
    newRange.setFontSize(10);
    newRange.setWrap(false);
    newRange.setVerticalAlignment("middle");
    
    if (lastRow % 2 === 0) {
      newRange.setBackground("#F0F4F8");
    } else {
      newRange.setBackground("#FFFFFF");
    }
    
    sheet.getRange(lastRow, 1).setFontWeight("bold");
    sheet.getRange(lastRow, 3).setFontWeight("bold").setFontColor("#0057A8");
    
    // Status color
    var estadoCol = COLUMNS.indexOf("ESTADO_CONFORMIDAD") + 1;
    var estadoVal = (data["ESTADO_CONFORMIDAD"] || "").toLowerCase();
    if (estadoVal.indexOf("no conforme") >= 0) {
      sheet.getRange(lastRow, estadoCol).setBackground("#FEF2F2").setFontColor("#991B1B");
    } else if (estadoVal.indexOf("conforme") >= 0) {
      sheet.getRange(lastRow, estadoCol).setBackground("#ECFDF5").setFontColor("#065F46");
    }
    
    // Make links clickable (photos + firmas + PDF)
    var linkCols = ["FOTO_EQUIPO","FOTO_CODIGO","FOTO_CAMBIO","FIRMA_TECNICO_LINK","FIRMA_USUARIO_LINK","PDF_RMP_LINK"];
    linkCols.forEach(function(colName) {
      var colIdx = COLUMNS.indexOf(colName) + 1;
      if (colIdx > 0) {
        var val = sheet.getRange(lastRow, colIdx).getValue();
        if (val && val.toString().indexOf("http") === 0) {
          sheet.getRange(lastRow, colIdx).setFontColor("#0057A8");
        }
      }
    });
    
    return ContentService
      .createTextOutput(JSON.stringify({ status: "ok", row: lastRow, pdfLink: pdfLink }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({ status: "error", message: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// ============================================================
// GENERATE PDF AND SAVE TO DRIVE
// ============================================================
function generateAndSavePDF(data, code, fecha) {
  var doc = DocumentApp.create("RMP_" + code + "_temp");
  var body = doc.getBody();
  body.setMarginTop(20);
  body.setMarginBottom(20);
  body.setMarginLeft(30);
  body.setMarginRight(30);
  
  var BLU = "#0077B6";
  var BLU2 = "#005F8A";
  var GRAY = "#5A6C7D";
  var DARK = "#1E293B";
  var ORANGE = "#9A3412";
  
  // ===== TITLE =====
  var title = body.appendParagraph("REPORTE DE MANTENIMIENTO PREVENTIVO — RMP");
  title.setAlignment(DocumentApp.HorizontalAlignment.CENTER);
  title.setFontSize(14);
  title.setBold(true);
  title.setForegroundColor(BLU2);
  
  // Subtitle
  var sub = body.appendParagraph(
    "SEDAPAL ETIC  |  RMP-" + code + "  |  " + (data["FECHA"] || "") + "  |  Técnico: " + (data["TÉCNICO"] || "")
  );
  sub.setAlignment(DocumentApp.HorizontalAlignment.CENTER);
  sub.setFontSize(8);
  sub.setForegroundColor(GRAY);
  
  // Timing
  var timing = body.appendParagraph(
    "Inicio: " + (data["HORA_INICIO"] || "") + "  |  Fin: " + (data["HORA_FIN"] || "") + "  |  Duración: " + (data["DURACION"] || "")
  );
  timing.setAlignment(DocumentApp.HorizontalAlignment.CENTER);
  timing.setFontSize(7);
  timing.setForegroundColor(ORANGE);
  
  body.appendParagraph("").setSpacingAfter(5);
  
  // ===== HELPER FUNCTIONS =====
  function addSection(num, title) {
    var p = body.appendParagraph(num + "  " + title);
    p.setFontSize(9);
    p.setBold(true);
    p.setForegroundColor(BLU);
    p.setSpacingBefore(8);
    p.setSpacingAfter(4);
  }
  
  function addTable(rows) {
    var table = body.appendTable(rows);
    table.setBorderColor("#D0DCE8");
    table.setBorderWidth(0.5);
    for (var r = 0; r < table.getNumRows(); r++) {
      var row = table.getRow(r);
      for (var c = 0; c < row.getNumCells(); c++) {
        var cell = row.getCell(c);
        cell.setPaddingTop(2);
        cell.setPaddingBottom(2);
        cell.setPaddingLeft(4);
        cell.setPaddingRight(4);
        
        var text = cell.getText();
        var para = cell.getChild(0).asParagraph();
        
        // Labels (UPPERCASE) in gray, values in dark
        if (text === text.toUpperCase() && text.length > 1 && !/^\d/.test(text)) {
          para.setFontSize(6);
          para.setForegroundColor(GRAY);
          cell.setBackgroundColor("#F8FAFC");
        } else {
          para.setFontSize(8);
          para.setForegroundColor(DARK);
          para.setBold(true);
        }
      }
    }
    return table;
  }
  
  // ===== 1. INFORMACIÓN DEL USUARIO =====
  addSection("1", "Información del usuario y área");
  addTable([
    ["USUARIO", data["USUARIO_ASIGNADO"] || "", "FICHA", data["FICHA_USUARIO"] || ""],
    ["CARGO", data["CARGO"] || "", "TIPO DE ASIGNACIÓN", data["TIPO_ASIGNACIÓN"] || ""],
    ["USUARIO OTRO", "", "GERENCIA", data["GERENCIA"] || ""],
    ["SEDE O LOCAL", data["SEDE"] || "", "EQUIPO FUNCIONAL", data["EQUIPO_FUNCIONAL"] || ""],
    ["REFERENCIA", data["REFERENCIA_UBICACIÓN"] || "", "GRUPO FUNCIONAL", data["GRUPO_FUNCIONAL"] || ""]
  ]);
  
  // ===== 2. INVENTARIO =====
  addSection("2", "Inventario del equipo asignado al usuario");
  addTable([
    ["C. INVENTARIO", data["CÓDIGO_INVENTARIO"] || "", "CONDICIÓN", "", "ESTADO", "", "EN USO", "En uso"],
    ["CATEGORÍA", data["CATEGORÍA"] || "", "TIPO", data["TIPO_DE_EQUIPO"] || "", "MARCA", data["MARCA"] || "", "MODELO", data["MODELO"] || ""]
  ]);
  
  // Periféricos
  var periP = body.appendParagraph("Periféricos");
  periP.setFontSize(8);
  periP.setBold(true);
  periP.setForegroundColor(BLU2);
  periP.setSpacingBefore(4);
  
  addTable([
    ["Monitor", "MARCA", data["MARCA_MONITOR_1"] || "", "MODELO", data["MODELO_MONITOR_1"] || "", "SERIE", data["SERIE_MONITOR_1"] || ""],
    ["Teclado", "MARCA", data["MARCA_TECLADO"] || "", "SERIE", data["SERIE_TECLADO"] || "", "", ""],
    ["Mouse", "MARCA", data["MARCA_MOUSE"] || "", "SERIE", data["SERIE_MOUSE"] || "", "", ""]
  ]);
  
  // ===== 3. DATOS ADICIONALES =====
  addSection("3", "Datos adicionales del Equipo");
  addTable([
    ["UND. ÓPTICA", "", "PROCESADOR", data["PROCESADOR"] || "", "MEMORIA RAM", data["MEMORIA_RAM"] || "", "DISCO DURO", data["ALMACENAMIENTO"] || ""],
    ["DIRECCIÓN IP", data["DIRECCIÓN_IP"] || "", "HOSTNAME", data["NOMBRE_HOST"] || "", "SISTEMA OPERATIVO", "", "", ""]
  ]);
  
  // ===== 4. CHECKLIST =====
  addSection("4", "Actividades de Mantenimiento realizados (Check list)");
  var cat = (data["CATEGORÍA"] || "").toUpperCase();
  var isPC = /PC|LAPTOP|WORKSTATION|WS/.test(cat);
  var isImp = /IMPRESORA|PLOTTER/.test(cat);
  var isEsc = /SCANNER|ESCANER/.test(cat);
  var isTab = /TABLET/.test(cat);
  var isMon = /MONITOR/.test(cat);
  var check = "✓";
  var noCheck = "○";
  
  var chkRows = [
    ["PC / WS / LAPTOP", "", "MONITOR", "", "IMPRESORA / PLOTTER", "", "SCANNER", ""],
    ["Diagnóstico previo", isPC?check:noCheck, "Diagnóstico previo", (isPC||isMon)?check:noCheck, "Diagnóstico previo", isImp?check:noCheck, "Diagnóstico previo", isEsc?check:noCheck],
    ["Valid. SW NO AUTORIZ.", isPC?check:noCheck, "Limpieza externa", (isPC||isMon)?check:noCheck, "Estado consumibles", isImp?check:noCheck, "Limp. interna mecán.", isEsc?check:noCheck],
    ["Limpieza ext.", isPC?check:noCheck, "Pruebas Operativ.", (isPC||isMon)?check:noCheck, "Limp. comp. internos", isImp?check:noCheck, "Limpieza externa", isEsc?check:noCheck],
    ["Valid. Antivirus", isPC?check:noCheck, "", "", "Lubric. partes mec.", isImp?check:noCheck, "Pruebas Operativ.", isEsc?check:noCheck],
    ["Valid. Discovery", isPC?check:noCheck, "", "", "Limpieza externa", isImp?check:noCheck, "", ""],
    ["Prueba Operativ.", isPC?check:noCheck, "", "", "Pruebas Operativ.", isImp?check:noCheck, "", ""]
  ];
  
  var chkTable = addTable(chkRows);
  // Bold headers
  for (var c = 0; c < chkTable.getRow(0).getNumCells(); c += 2) {
    var hCell = chkTable.getRow(0).getCell(c);
    hCell.getChild(0).asParagraph().setBold(true);
    hCell.getChild(0).asParagraph().setForegroundColor(BLU2);
    hCell.getChild(0).asParagraph().setFontSize(7);
    hCell.setBackgroundColor("#EBF5FF");
  }
  
  // TABLET section
  if (isTab) {
    var tabP = body.appendParagraph("TABLET: " + check + " Diagnóstico previo  " + check + " Limpieza case externo  " + check + " Pruebas Operatividad");
    tabP.setFontSize(7);
    tabP.setForegroundColor(DARK);
  }
  
  // ===== 5. OBSERVACIONES =====
  addSection("5", "Observaciones de M. Preventivo");
  var obsText = data["CAMBIOS_REALIZADOS"] || data["OBSERVACIONES"] || "(Sin observaciones)";
  var obsP = body.appendParagraph(obsText);
  obsP.setFontSize(8);
  obsP.setForegroundColor(DARK);
  
  // ===== 6. ENCUESTA =====
  addSection("6", "Encuesta de Calidad de servicio");
  var legend = body.appendParagraph("1=Muy Malo  |  2=Malo  |  3=Regular  |  4=Bueno  |  5=Muy Bueno");
  legend.setAlignment(DocumentApp.HorizontalAlignment.CENTER);
  legend.setFontSize(7);
  legend.setForegroundColor(ORANGE);
  
  var tratoVal = parseInt(data["ENCUESTA_TRATO"]) || 0;
  var confVal = parseInt(data["ENCUESTA_CONFORMIDAD"]) || 0;
  
  function surveyLine(label, val) {
    var marks = "";
    for (var n = 1; n <= 5; n++) {
      marks += (n === val) ? " [" + n + "] " : "  " + n + "  ";
    }
    return label + ":  " + marks;
  }
  
  var s1 = body.appendParagraph(surveyLine("Presentación y Trato del Personal Técnico", tratoVal));
  s1.setFontSize(8); s1.setForegroundColor(DARK);
  var s2 = body.appendParagraph(surveyLine("Conformidad del Usuario con el mantenimiento", confVal));
  s2.setFontSize(8); s2.setForegroundColor(DARK);
  
  // ===== 7 & 8. FIRMAS =====
  body.appendParagraph("").setSpacingAfter(5);
  
  var firmaTable = body.appendTable([
    ["7. Técnico de Mant. Preventivo", "8. Conformidad de Usuario"],
    ["", ""],
    ["NOMBRES:\n" + (data["TÉCNICO"] || ""), "NOMBRES:\n" + (data["USUARIO_ASIGNADO"] || "")]
  ]);
  firmaTable.setBorderColor("#D0DCE8");
  firmaTable.setBorderWidth(0.5);
  
  // Style firma headers
  for (var fc = 0; fc < 2; fc++) {
    var hdrCell = firmaTable.getRow(0).getCell(fc);
    hdrCell.setBackgroundColor("#E8F4FD");
    hdrCell.getChild(0).asParagraph().setBold(true);
    hdrCell.getChild(0).asParagraph().setForegroundColor(BLU2);
    hdrCell.getChild(0).asParagraph().setFontSize(8);
    
    // Firma image row - set height
    var sigCell = firmaTable.getRow(1).getCell(fc);
    sigCell.setPaddingTop(10);
    sigCell.setPaddingBottom(10);
    sigCell.setBackgroundColor("#FFFFFF");
  }
  
  // Insert signature images if available
  try {
    if (data["FIRMA_TECNICO"] && data["FIRMA_TECNICO"].length > 100) {
      var sigParts = data["FIRMA_TECNICO"].split(",");
      var sigBytes = Utilities.base64Decode(sigParts.length > 1 ? sigParts[1] : sigParts[0]);
      var sigBlob = Utilities.newBlob(sigBytes, "image/png", "firma_tec.png");
      var sigCell1 = firmaTable.getRow(1).getCell(0);
      sigCell1.clear();
      var sigPara1 = sigCell1.appendParagraph("");
      sigPara1.setAlignment(DocumentApp.HorizontalAlignment.CENTER);
      var img1 = sigPara1.appendInlineImage(sigBlob);
      img1.setWidth(180);
      img1.setHeight(80);
    }
  } catch(sigErr) {}
  
  try {
    if (data["FIRMA_USUARIO"] && data["FIRMA_USUARIO"].length > 100) {
      var sigParts2 = data["FIRMA_USUARIO"].split(",");
      var sigBytes2 = Utilities.base64Decode(sigParts2.length > 1 ? sigParts2[1] : sigParts2[0]);
      var sigBlob2 = Utilities.newBlob(sigBytes2, "image/png", "firma_usr.png");
      var sigCell2 = firmaTable.getRow(1).getCell(1);
      sigCell2.clear();
      var sigPara2 = sigCell2.appendParagraph("");
      sigPara2.setAlignment(DocumentApp.HorizontalAlignment.CENTER);
      var img2 = sigPara2.appendInlineImage(sigBlob2);
      img2.setWidth(180);
      img2.setHeight(80);
    }
  } catch(sigErr2) {}
  
  // Names row style
  for (var nc = 0; nc < 2; nc++) {
    var nameCell = firmaTable.getRow(2).getCell(nc);
    nameCell.getChild(0).asParagraph().setFontSize(7);
    nameCell.getChild(0).asParagraph().setForegroundColor(DARK);
  }
  
  // ===== FOOTER =====
  body.appendParagraph("").setSpacingAfter(10);
  var footer = body.appendParagraph("Proyecto MANANTIAL — Mantenimiento Preventivo SEDAPAL ETIC — Derechos Reservados");
  footer.setAlignment(DocumentApp.HorizontalAlignment.CENTER);
  footer.setFontSize(7);
  footer.setForegroundColor(GRAY);
  
  // ===== CONVERT TO PDF =====
  doc.saveAndClose();
  
  var docFile = DriveApp.getFileById(doc.getId());
  var pdfBlob = docFile.getAs("application/pdf");
  pdfBlob.setName("RMP_" + code + "_" + Utilities.formatDate(new Date(), "America/Lima", "yyyy-MM-dd") + ".pdf");
  
  // Get or create PDF folder with monthly subfolder
  var pdfFolder = getOrCreateFolder(PDF_FOLDER_NAME);
  var monthFolder = getOrCreateSubfolder(pdfFolder, Utilities.formatDate(new Date(), "America/Lima", "yyyy-MM"));
  
  var pdfFile = monthFolder.createFile(pdfBlob);
  pdfFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
  
  // Delete temp doc
  docFile.setTrashed(true);
  
  return pdfFile.getUrl();
}

// ============================================================
// DRIVE HELPERS
// ============================================================
function getOrCreateFolder(name) {
  var folders = DriveApp.getFoldersByName(name);
  if (folders.hasNext()) return folders.next();
  var folder = DriveApp.createFolder(name);
  folder.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
  return folder;
}

function getOrCreateSubfolder(parent, name) {
  var folders = parent.getFoldersByName(name);
  if (folders.hasNext()) return folders.next();
  var folder = parent.createFolder(name);
  folder.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
  return folder;
}

function savePhotoToDrive(base64Data, fileName) {
  try {
    var folder = getOrCreateFolder(DRIVE_FOLDER_NAME);
    
    var parts = base64Data.split(",");
    var contentType = "image/jpeg";
    if (parts.length > 1) {
      var match = parts[0].match(/data:([^;]+)/);
      if (match) contentType = match[1];
      base64Data = parts[1];
    }
    
    var blob = Utilities.newBlob(Utilities.base64Decode(base64Data), contentType, fileName);
    var file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    return file.getUrl();
  } catch (err) {
    return "Error: " + err.toString();
  }
}

// ============================================================
// CREATE SHEET
// ============================================================
function createSheet(ss) {
  var sheet = ss.insertSheet(SHEET_NAME);
  
  sheet.getRange(1, 1, 1, COLUMNS.length).setValues([COLUMNS]);
  
  var headerRange = sheet.getRange(1, 1, 1, COLUMNS.length);
  headerRange.setBackground("#0057A8");
  headerRange.setFontColor("#FFFFFF");
  headerRange.setFontWeight("bold");
  headerRange.setFontSize(9);
  headerRange.setWrap(false);
  sheet.setFrozenRows(1);
  
  var cleanRange = sheet.getRange(2, 1, 100, COLUMNS.length);
  cleanRange.setBackground("#FFFFFF");
  cleanRange.setFontColor("#1E293B");
  cleanRange.setFontWeight("normal");
  cleanRange.setFontSize(10);
  
  sheet.setColumnWidth(1, 170);
  sheet.setColumnWidth(2, 180);
  sheet.setColumnWidth(3, 150);
  for (var i = 4; i <= COLUMNS.length; i++) {
    sheet.setColumnWidth(i, 140);
  }
  sheet.setColumnWidth(41, 300);
  sheet.setColumnWidth(45, 250);
  sheet.setColumnWidth(47, 250);
  
  // Photo columns
  sheet.setColumnWidth(COLUMNS.indexOf("FOTO_EQUIPO") + 1, 250);
  sheet.setColumnWidth(COLUMNS.indexOf("FOTO_CODIGO") + 1, 250);
  sheet.setColumnWidth(COLUMNS.indexOf("FOTO_CAMBIO") + 1, 250);
  // New columns
  sheet.setColumnWidth(COLUMNS.indexOf("PDF_RMP_LINK") + 1, 300);
  sheet.setColumnWidth(COLUMNS.indexOf("FIRMA_TECNICO_LINK") + 1, 250);
  sheet.setColumnWidth(COLUMNS.indexOf("FIRMA_USUARIO_LINK") + 1, 250);
  
  return sheet;
}

function doGet(e) {
  return ContentService
    .createTextOutput(JSON.stringify({ 
      status: "ok", 
      message: "SEDAPAL Mantenimiento API v7 — con PDF automático"
    }))
    .setMimeType(ContentService.MimeType.JSON);
}
